#! /usr/bin/env ruby

require 'json'

def main
  top = `git rev-parse --show-toplevel`.strip
  sources = JSON.parse(File.read(File.join(top, 'ubuntu.json')))

  successes = sources.select do |src|
    puts "-------------------\nAdding #{src.inspect}\n"
    if !src['sourceline'].start_with?('ppa:')
      system("sudo -E apt-key add #{top}/keys/#{src['alias'].untaint}.asc")
    end
    system("sudo -E apt-add-repository -y #{src['sourceline'].untaint.inspect}")
  end

  sources.length == successes.length
end

exit main if $PROGRAM_NAME == __FILE__
